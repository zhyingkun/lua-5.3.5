<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PortAudio: Writing a Callback Function</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PortAudio
   &#160;<span id="projectnumber">2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Writing a Callback Function </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To write a program using PortAudio, you must include the "portaudio.h" include file. You may wish to read "portaudio.h" because it contains a complete description of the PortAudio functions and constants. Alternatively, you could browse the [<a href="http://www.portaudio.com/docs/v19-doxydocs/portaudio_8h.html">http://www.portaudio.com/docs/v19-doxydocs/portaudio_8h.html</a> "portaudio.h" Doxygen page] </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="portaudio_8h.html">portaudio.h</a>&quot;</span></div>
<div class="ttc" id="aportaudio_8h_html"><div class="ttname"><a href="portaudio_8h.html">portaudio.h</a></div><div class="ttdoc">The portable PortAudio API.</div></div>
</div><!-- fragment --><p> The next task is to write your own "callback" function. The "callback" is a function that is called by the PortAudio engine whenever it has captured audio data, or when it needs more audio data for output.</p>
<p>Before we begin, it's important to realize that the callback is a delicate place. This is because some systems perform the callback in a special thread, or interrupt handler, and it is rarely treated the same as the rest of your code. For most modern systems, you won't be able to cause crashes by making disallowed calls in the callback, but if you want your code to produce glitch-free audio, you will have to make sure you avoid function calls that may take an unbounded amount of time to execute. Exactly what these are depend on your platform but almost certainly include the following: memory allocation/deallocation, I/O (including file I/O as well as console I/O, such as printf()), context switching (such as exec() or yield()), mutex operations, or anything else that might rely on the OS. If you think short critical sections are safe please go read about priority inversion. Windows and Mac OS schedulers have no real-time safe priority inversion prevention. Other platforms require special mutex flags. In addition, it is not safe to call any PortAudio API functions in the callback except as explicitly permitted in the documentation.</p>
<p>Your callback function must return an int and accept the exact parameters specified in this typedef:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keywordtype">int</span> <a class="code" href="portaudio_8h.html#a8a60fb2a5ec9cbade3f54a9c978e2710">PaStreamCallback</a>( <span class="keyword">const</span> <span class="keywordtype">void</span> *input,</div>
<div class="line">                                      <span class="keywordtype">void</span> *output,</div>
<div class="line">                                      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frameCount,</div>
<div class="line">                                      <span class="keyword">const</span> <a class="code" href="structPaStreamCallbackTimeInfo.html">PaStreamCallbackTimeInfo</a>* timeInfo,</div>
<div class="line">                                      <a class="code" href="portaudio_8h.html#a55a005924bcfa0424594f4f65cd4ae82">PaStreamCallbackFlags</a> statusFlags,</div>
<div class="line">                                      <span class="keywordtype">void</span> *userData ) ;</div>
<div class="ttc" id="aportaudio_8h_html_a55a005924bcfa0424594f4f65cd4ae82"><div class="ttname"><a href="portaudio_8h.html#a55a005924bcfa0424594f4f65cd4ae82">PaStreamCallbackFlags</a></div><div class="ttdeci">unsigned long PaStreamCallbackFlags</div><div class="ttdef"><b>Definition:</b> <a href="portaudio_8h_source.html#l00712">portaudio.h:712</a></div></div>
<div class="ttc" id="aportaudio_8h_html_a8a60fb2a5ec9cbade3f54a9c978e2710"><div class="ttname"><a href="portaudio_8h.html#a8a60fb2a5ec9cbade3f54a9c978e2710">PaStreamCallback</a></div><div class="ttdeci">int PaStreamCallback(const void *input, void *output, unsigned long frameCount, const PaStreamCallbackTimeInfo *timeInfo, PaStreamCallbackFlags statusFlags, void *userData)</div><div class="ttdef"><b>Definition:</b> <a href="portaudio_8h_source.html#l00830">portaudio.h:830</a></div></div>
<div class="ttc" id="astructPaStreamCallbackTimeInfo_html"><div class="ttname"><a href="structPaStreamCallbackTimeInfo.html">PaStreamCallbackTimeInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="portaudio_8h_source.html#l00699">portaudio.h:699</a></div></div>
</div><!-- fragment --><p> Here is an example callback function from the test file "patests/patest_saw.c". It calculates a simple left and right sawtooth signal and writes it to the output buffer. Notice that in this example, the signals are of float data type. The signals must be between -1.0 and +1.0. You can also use 16 bit integers or other formats which are specified during setup, but floats are easiest to work with. You can pass a pointer to your data structure through PortAudio which will appear as userData.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> left_phase;</div>
<div class="line">    <span class="keywordtype">float</span> right_phase;</div>
<div class="line">}   </div>
<div class="line"><a class="code" href="structpaTestData.html">paTestData</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* This routine will be called by the PortAudio engine when audio is needed.</span></div>
<div class="line"><span class="comment"> * It may called at interrupt level on some machines so don&#39;t do anything</span></div>
<div class="line"><span class="comment"> * that could mess up the system like calling malloc() or free().</span></div>
<div class="line"><span class="comment">*/</span> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> patestCallback( <span class="keyword">const</span> <span class="keywordtype">void</span> *inputBuffer, <span class="keywordtype">void</span> *outputBuffer,</div>
<div class="line">                           <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> framesPerBuffer,</div>
<div class="line">                           <span class="keyword">const</span> <a class="code" href="structPaStreamCallbackTimeInfo.html">PaStreamCallbackTimeInfo</a>* timeInfo,</div>
<div class="line">                           <a class="code" href="portaudio_8h.html#a55a005924bcfa0424594f4f65cd4ae82">PaStreamCallbackFlags</a> statusFlags,</div>
<div class="line">                           <span class="keywordtype">void</span> *userData )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Cast data passed through stream to our structure. */</span></div>
<div class="line">    <a class="code" href="structpaTestData.html">paTestData</a> *data = (<a class="code" href="structpaTestData.html">paTestData</a>*)userData; </div>
<div class="line">    <span class="keywordtype">float</span> *out = (<span class="keywordtype">float</span>*)outputBuffer;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;</div>
<div class="line">    (void) inputBuffer; <span class="comment">/* Prevent unused variable warning. */</span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span>( i=0; i&lt;framesPerBuffer; i++ )</div>
<div class="line">    {</div>
<div class="line">        *out++ = data-&gt;left_phase;  <span class="comment">/* left */</span></div>
<div class="line">        *out++ = data-&gt;right_phase;  <span class="comment">/* right */</span></div>
<div class="line">        <span class="comment">/* Generate simple sawtooth phaser that ranges between -1.0 and 1.0. */</span></div>
<div class="line">        data-&gt;left_phase += 0.01f;</div>
<div class="line">        <span class="comment">/* When signal reaches top, drop back down. */</span></div>
<div class="line">        <span class="keywordflow">if</span>( data-&gt;left_phase &gt;= 1.0f ) data-&gt;left_phase -= 2.0f;</div>
<div class="line">        <span class="comment">/* higher pitch so we can distinguish left and right. */</span></div>
<div class="line">        data-&gt;right_phase += 0.03f;</div>
<div class="line">        <span class="keywordflow">if</span>( data-&gt;right_phase &gt;= 1.0f ) data-&gt;right_phase -= 2.0f;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="astructpaTestData_html"><div class="ttname"><a href="structpaTestData.html">paTestData</a></div><div class="ttdef"><b>Definition:</b> <a href="paex__mono__asio__channel__select_8c_source.html#l00065">paex_mono_asio_channel_select.c:66</a></div></div>
</div><!-- fragment --><p>Previous: <a class="el" href="tutorial_start.html">PortAudio Tutorials</a> | Next: <a class="el" href="initializing_portaudio.html">Initializing PortAudio</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
